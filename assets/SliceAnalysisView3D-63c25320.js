import{cz as Yt,ck as Qt,ja as Jt,ai as u,aj as d,c7 as ei,f4 as et,gL as tt,gM as it,al as ce,bh as y,cn as ti,lV as me,ia as ii,ib as ai,a_ as at,id as st,lJ as nt,ii as si,im as ni,aw as ri,is as li,it as oi,iu as ui,iv as hi,oK as ci,ip as pe,hL as di,iB as pi,mN as gi,i$ as be,iH as _i,n$ as wi,iJ as yi,iK as vi,hH as fi,hI as Pi,lO as mi,i_ as C,j0 as rt,g3 as bi,oQ as Ce,kC as $t,j7 as o,gu as w,fs as I,py as Dt,mF as A,dQ as B,dR as $,gv as v,n2 as M,j1 as x,pz as Ge,o3 as Ot,pe as k,pA as Vi,pB as Ue,pC as Mi,pD as Ti,h9 as St,dS as te,pE as Ke,j8 as Rt,mR as Q,pF as It,na as Ei,pf as At,j6 as he,o$ as F,dT as J,l9 as Ci,hQ as kt,kf as $i,pG as Di,lx as V,pH as Ne,dk as j,j2 as ge,ir as _e,oC as lt,pI as Ve,pJ as Oi,bz as xt,j3 as Si,p3 as ot,nZ as ut,fu as Re,fr as ht,pK as ct,pL as dt,pM as pt,pN as Ri,gU as Ii,ao as qe,af as Me,aA as gt,aG as R,pO as Ai,l$ as ki,kI as xi,hW as Li,aH as Hi,aM as ze,aq as _t,ah as W,pw as oe,pP as b,pQ as wt,n1 as Be,kH as fe,pR as Gi,pS as Ui,ft as yt,pT as Ni,hV as vt,kD as ft,kG as zi,kF as Bi,pU as Lt,pV as Ht,kK as Fi,lQ as ji}from"./index-080e108a.js";import{i as ie,u as Gt,b as Wi,c as Ki,r as qi,a as Zi,e as Xi}from"./LineVisualElement-b605d10c.js";import{g as ue}from"./persistable-ca976a2c.js";import{C as Yi}from"./BuildingComponentSublayer-5d49e5f9.js";import{N as Qi,$ as Ut,e as H,R as Ji,U as ea,a as ta,d as we,D as ia,b as aa,v as sa}from"./analysisViewUtils-68ab721d.js";import{n as na,l as ra,H as ye}from"./Factory-8e329f4b.js";let L=class extends Yt(Qt){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&Jt(this.position,t.position)&&this.width===t.width&&this.height===t.height}};u([d({readOnly:!0,json:{read:!1,write:!0}})],L.prototype,"type",void 0),u([d({type:ei}),ue()],L.prototype,"position",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:360}}),ue(),et(e=>tt.normalize(it(e),0,!0))],L.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:360}}),ue(),et(e=>tt.normalize(it(e),0,!0))],L.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0}),ue()],L.prototype,"width",void 0),u([d({type:Number,nonNullable:!0}),ue()],L.prototype,"height",void 0),L=u([ce("esri.analysis.SlicePlane")],L);const Ze=L;let la=class{constructor(){this.color=ie()}},oa=class{constructor(){this.color=new y([0,0,0,.04]),this.gridColor=ie(.5),this.outlineColor=ie(.7)}},ua=class{constructor(){this.color=ie()}},ha=class{constructor(){this.color=ie(.5),this.contrastColor=Gt()}},ca=class{constructor(){this.color=Gt(),this.outlineColor=ie()}},da=class{constructor(){this.callouts=new la,this.plane=new oa,this.resizeManipulators=new ua,this.rotateManipulators=new ha,this.shiftManipulator=new ca}},P=new da;const Ie=ti("mac")?"Meta":"Control",Ae="Shift",pa=2,ga=1.15,_a=1.15,wa=2500,ya=.02,va=Math.cos(me(45)),Pt=Math.cos(me(5)),fa=.95,Pa=.3,Nt=2,zt=1,ma=3,Bt=11,Fe=22.5,Pe=40,mt=48,ba=2.25,Va=4,bt=1,Ma=.3,Ta=6,Ea=4,Vt=1600,Ca=.4;function $a(e){const t=new ii,{vertex:i,fragment:a,attributes:s,varyings:n}=t;return ai(i,e),s.add(at.POSITION,"vec3"),s.add(at.UV0,"vec2"),n.add("vUV","vec2"),i.code.add(st`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),a.uniforms.add(new nt("backgroundColor",r=>r.backgroundColor),new nt("gridColor",r=>r.gridColor),new si("gridWidth",r=>r.gridWidth)),a.code.add(st`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const Da=Object.freeze(Object.defineProperty({__proto__:null,build:$a},Symbol.toStringTag,{value:"Module"}));let Oa=class extends gi{constructor(){super(...arguments),this.backgroundColor=be(1,0,0,.5),this.gridColor=be(0,1,0,.5),this.gridWidth=4}};class $e extends li{initializeProgram(t){return new oi(t.rctx,$e.shader.get().build(this.configuration),ui)}initializePipeline(){return hi({blending:ci(pe.ONE,pe.ONE,pe.ONE_MINUS_SRC_ALPHA,pe.ONE_MINUS_SRC_ALPHA),depthTest:{func:di.LESS},colorWrite:pi})}}$e.shader=new ni(Da,()=>ri(()=>import("./SlicePlaneMaterial.glsl-99e82c24.js"),["assets/SlicePlaneMaterial.glsl-99e82c24.js","assets/index-080e108a.js","assets/index-a8e73b5e.css","assets/LineVisualElement-b605d10c.js","assets/persistable-ca976a2c.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-91e7c3ce.js","assets/BuildingComponentSublayer-5d49e5f9.js","assets/UniqueValueRenderer-fef4204d.js","assets/diffUtils-590c9088.js","assets/jsonUtils-f73b3833.js","assets/DictionaryLoader-c0729336.js","assets/FieldsIndex-f79a8f26.js","assets/heatmapUtils-327ef4c5.js","assets/FeatureLayer-5c6d2c3b.js","assets/MultiOriginJSONSupport-e4912ffd.js","assets/sql-734ecbc5.js","assets/FeatureLayerBase-7c7dfccb.js","assets/commonProperties-30089b06.js","assets/featureLayerUtils-6cf06f83.js","assets/AttachmentQuery-972bbd60.js","assets/Query-1c961d4c.js","assets/RelationshipQuery-39c07195.js","assets/serviceCapabilitiesUtils-959e798a.js","assets/editsZScale-1b5a53a6.js","assets/queryZScale-8f9616ff.js","assets/FeatureSet-111cb247.js","assets/APIKeyMixin-878a7aa7.js","assets/ArcGISService-83287338.js","assets/CustomParametersMixin-231c4be8.js","assets/EditBusLayer-d71787e9.js","assets/FeatureEffectLayer-4160946c.js","assets/FeatureEffect-86735d98.js","assets/FeatureFilter-00f4be05.js","assets/FeatureReductionLayer-4262cf54.js","assets/LabelClass-2d53c485.js","assets/defaults-34554cbf.js","assets/defaultsJSON-59981e75.js","assets/OperationalLayer-0e8f8b28.js","assets/OrderedLayer-68067459.js","assets/PortalLayer-310c2800.js","assets/portalItemUtils-792a27e1.js","assets/TemporalLayer-f17c9161.js","assets/FeatureTemplate-2a7e96c1.js","assets/FeatureType-db96032c.js","assets/fieldProperties-62c55499.js","assets/labelingInfo-144f3d9f.js","assets/versionUtils-f17daa93.js","assets/styleUtils-25825fd6.js","assets/TopFeaturesQuery-e44d05be.js","assets/popupUtils-82ea8abb.js","assets/capabilities-5d185925.js","assets/I3SIndexInfo-445e6968.js","assets/I3SLayerDefinitions-ffdb3821.js","assets/I3SUtil-2c288808.js","assets/I3SBinaryReader-2b8e30f7.js","assets/popupUtils-f04ec9a9.js","assets/analysisViewUtils-68ab721d.js","assets/ImageMaterial-5c48df66.js","assets/Factory-8e329f4b.js"]));class Sa extends _i{constructor(t){super(t,new Ia),this._configuration=new wi}createBufferWriter(){return new yi(vi)}requiresSlot(t,i){return i===fi.Color&&t===Pi.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(t){return new Ra(t)}getConfiguration(){return this._configuration}}let Ra=class extends mi{constructor(t){super(t),this.ensureTechnique($e,null)}beginSlot(){return this.technique}},Ia=class extends Oa{constructor(){super(...arguments),this.renderOccluded=C.Occlude}},Aa=class extends Wi{constructor(t){super(t),this._material=null,this._renderOccluded=C.OccludeAndTransparent,this._gridWidth=1,this._gridColor=be(1,0,0,1),this._backgroundColor=be(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){rt(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){rt(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new Sa(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){this._material!=null&&t(this._material)}createGeometries(t){if(this._material!=null){const i=bi(this._material);t.addGeometry(i)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){this._material!=null&&this._material.setParameters(this._materialParameters)}};function ka(e,t,i,a,s,n,r,l){return xa(t,r.worldUpAtPosition(e,o.get()),s,n,l.basis1,l.basis2),w(l.basis1,l.basis1,i),w(l.basis2,l.basis2,a),I(l.origin,e),Dt(l.basis2,l.basis1,l.origin,l.plane),l}function xa(e,t,i,a,s,n){const r=A(e,t),l=o.get(),h=o.get();switch(a===E.HORIZONTAL_OR_VERTICAL?Math.abs(r)>va?E.HORIZONTAL:E.VERTICAL:a){case E.VERTICAL:{const g=Math.abs(r)<=Pt?e:i.viewUp;B(l,g,t),I(h,t);break}case E.HORIZONTAL:B(l,i.viewUp,t),B(h,t,l);break;case E.TILTED:{const g=Math.abs(r)<=Pt?t:i.viewUp;B(l,g,e),B(h,e,l);break}}const _=B(o.get(),l,h);A(_,i.viewForward)>0&&w(h,h,-1),$(s,l),$(n,h)}function La(e,t,i){const a=t.worldUpAtPosition(e.origin,o.get()),s=e.basis1,n=Qe(e,a),r=Math.round(n/se)*se;return Ne(e,r-n,s,i)}function Ha(e,t,i,a,s,n){const r=I(o.get(),s.origin);v(r,r,w(o.get(),s.basis1,e.direction[0]<0?1:-1)),v(r,r,w(o.get(),s.basis2,e.direction[1]<0?1:-1));const l=M(s.basis1),h=M(s.basis2),_=x(o.get(),i,r),g=x(o.get(),t,r);let p=0,c=0;if(Ye(e)){const O=je(s),De=je(n);p=l-.5*e.direction[0]*A(s.basis1,g)/l,c=h-.5*e.direction[1]*A(s.basis2,g)/h;const ne=De/O;p*=ne,c*=ne}const D=p+.5*e.direction[0]*A(s.basis1,_)/l,T=c+.5*e.direction[1]*A(s.basis2,_)/h,K=w(o.get(),s.basis1,D/l),U=w(o.get(),s.basis2,T/h);(D<=0||Tt(n.origin,K,a)<=Vt)&&I(K,n.basis1),(T<=0||Tt(n.origin,U,a)<=Vt)&&I(U,n.basis2);const N=I(o.get(),r);return v(N,N,w(o.get(),K,e.direction[0]<0?-1:1)),v(N,N,w(o.get(),U,e.direction[1]<0?-1:1)),Ge(N,K,U,n)}function Ga(e,t){return Ca*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Ua(e,t,i,a){const s=B(o.get(),t,i);return B(s,s,t),Ot(e,s,a)}function Ft(e,t){return Qi(e.basis1,e.basis2,e.origin,t)}function Mt(e,t,i,a){const s=t.worldUpAtPosition(e.origin,o.get()),n=o.get();switch(i){case ae.HEADING:I(n,s);break;case ae.TILT:I(n,e.basis1)}return Ot(e.origin,n,a)}function Na(e,t,i,a){const s=Xe(i,G.NEGATIVE_X),n=k.get();Vi(n,t,s.edge*Math.PI/2);const r=$(o.get(),s.basis);let l=w(o.get(),r,s.direction*a.computeScreenPixelSizeAt(s.position)*Pe);v(l,l,s.position);const h=a.projectToRenderScreen(l,Ue(o.get())),_=za(a,h);Mi(a,h,ve),$(ve.direction,ve.direction);const g=o.get();!_&&Ti(i,ve,g)&&(l=g),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=St(l),_?e.state|=Te:e.state&=~Te}function za(e,t){const[i,a,s,n]=e.viewport,r=Math.min(s,n)/16;let l=!0;return t[0]<i+r?(t[0]=i+r,l=!1):t[0]>i+s-r&&(t[0]=i+s-r,l=!1),t[1]<a+r?(t[1]=a+r,l=!1):t[1]>a+n-r&&(t[1]=a+n-r,l=!1),l}function Ba(e,t,i,a){const s=M(a.basis1),n=M(a.basis2),r=jt(a),l=je(a),h=te(o.get(),0,0,0);v(h,w(o.get(),a.basis1,t.direction[0]),w(o.get(),a.basis2,t.direction[1])),v(h,a.origin,h);let _=0,g=1;if(Ye(t))t.direction[0]===1&&t.direction[1]===-1?_=se:t.direction[0]===1&&t.direction[1]===1?_=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(_=3*Math.PI/2),g=l;else{const c=t.direction[0]!==0?1:2;_=c===1?se:0,g=(c===1?n:s)-r}const p=Ke(k.get(),_);Rt(p,p,te(o.get(),g,g,g)),Q(p,i,p),p[12]=0,p[13]=0,p[14]=0,e.modelTransform=p,e.renderLocation=h}function Fa(e,t,i,a){const s=a.worldUpAtPosition(i.origin,o.get()),n=Xe(i,G.POSITIVE_X),r=Ke(k.get(),n.edge*Math.PI/2);It(r,r,-Qe(i,s)),Q(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=n.position}function ja(e,t,i){const a=Xe(i,G.POSITIVE_Y),s=Ke(k.get(),a.edge*Math.PI/2);It(s,s,se),Q(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}var G;function Xe(e,t){switch(t){case G.POSITIVE_X:return{basis:e.basis1,direction:1,position:v(o.get(),e.origin,e.basis1),edge:t};case G.POSITIVE_Y:return{basis:e.basis2,direction:1,position:v(o.get(),e.origin,e.basis2),edge:t};case G.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:x(o.get(),e.origin,e.basis1),edge:t};case G.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:x(o.get(),e.origin,e.basis2),edge:t}}}function Tt(e,t,i){const a=i.projectToRenderScreen(v(o.get(),e,t),Ue(o.get())),s=i.projectToRenderScreen(x(o.get(),e,t),Ue(o.get()));return Ei(x(a,a,s))}function jt(e){const t=M(e.basis1),i=M(e.basis2);return Ma*Math.min(t,i)}function je(e){return jt(e)}function Ye(e){return e.direction[0]!==0&&e.direction[1]!==0}function Wa(e,t){const i=t.offsetMode===Ee.CENTER_ON_CALLOUT?Pe:0,a=[j(i,0,-mt/2),j(i,0,mt/2)],s=Xa(a,!0),n=(p,c)=>qa(a,p,c,t),r=n(0,!1),l=n(ba,!0),h=new At({color:y.toUnitRGBA(t.calloutColor),renderOccluded:C.OccludeAndTransparent}),_=he(h,[[i,0,0],[i-Pe,0,0]]),g=he(h,[[i,0,0],[i-Pe,0,0]]);return new Ut({view:e,renderObjects:[...r.normal.map(p=>new H(p,F.Unfocused|m)),...l.normal.map(p=>new H(p,F.Unfocused|m)),new H(_,F.Unfocused|m|Te),...r.focused.map(p=>new H(p,F.Focused|m)),...l.focused.map(p=>new H(p,F.Focused|m)),new H(g,F.Focused|m|Te)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:Bt,state:m})}function Et(e,t){const i=Ji(e,{calloutColor:y.toUnitRGBA(P.callouts.color),customStateMask:m,texture:t});return i.state=m,i}function Wt(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new Ki({view:e,attached:!1,color:y.toUnitRGBA(P.plane.outlineColor),width:zt,renderOccluded:C.OccludeAndTransparent,geometry:[t]})}function Kt(e){return new Aa({view:e,attached:!1,backgroundColor:y.toUnitRGBA(P.plane.color),gridColor:y.toUnitRGBA(P.plane.gridColor),gridWidth:4,renderOccluded:C.OccludeAndTransparent})}function Ka(e,t,i){const a=Ye(t),s=a?[j(1,0,0),j(0,0,0),j(0,1,0)]:[j(1,0,0),j(-1,0,0)],n=y.toUnitRGBA(i.color),r=T=>new Si({color:n,width:T,renderOccluded:C.OccludeAndTransparent}),l=()=>new At({color:n,renderOccluded:C.OccludeAndTransparent}),h=a?Va:bt,_=h*pa,g=bt,p=T=>T>1?r(T):l(),c=[new H(he(p(h),s),F.Unfocused|ke),new H(he(p(_),s),F.Focused|ke),new H(he(p(g),s),es)],D=new Ut({view:e,renderObjects:c,collisionType:{type:"line",paths:[s]},radius:a?Ta:Ea,...ea});return D.state=ke,D}function qa(e,t,i,a){const s=y.blendColors(a.color,a.outlineColor,.4),n=y.blendColors(a.color,a.outlineColor,.14),r=new ge({color:y.toUnitRGBA(a.color),cullFace:_e.Back,renderOccluded:C.Opaque}),l=new ge({color:y.toUnitRGBA(s),cullFace:_e.Back,renderOccluded:C.Opaque}),h=new ge({color:y.toUnitRGBA(n),cullFace:_e.Back,renderOccluded:C.Opaque}),_=new ge({color:y.toUnitRGBA(a.outlineColor),transparent:!0,writeDepth:!1,cullFace:_e.Front,renderOccluded:C.Transparent}),g=p=>{const c=e.slice(0),D=x(o.get(),c[0],c[1]);$(D,D);const T=x(o.get(),c[c.length-1],c[c.length-2]);if($(T,T),t>0){const le=w(J(),T,-t);c[c.length-1]=v(le,le,c[c.length-1]);const ee=w(J(),D,-t);c[0]=v(ee,ee,c[0])}const K=p?_a:1,U=Fe*K,N=Bt*K,O=ot(k.get());if(t>0){const le=U/4,ee=te(o.get(),0,le,0),de=1+t/le;ut(O,O,ee),Rt(O,O,te(o.get(),de,de,de)),ut(O,O,w(ee,ee,-1/de))}const De=ot(Re()),ne=j(0,1,0),q=ht(Re(),ct(dt.get(),ne,T));q[12]=c[c.length-1][0],q[13]=c[c.length-1][1],q[14]=c[c.length-1][2],Q(q,q,O);const Je=Za(ma*(p?ga:1)+t,c,i?_:h);Je.transformation=De;const re=[Je],Oe=pt(i?_:r,U,N,24,!1,!1,!0);Oe.transformation=q,re.push(Oe);const Se=pt(i?_:l,U,N,24,!1,!0,!1);Se.transformation=q,re.push(Se);const Z=ht(Re(),ct(dt.get(),ne,D));return Z[12]=c[0][0],Z[13]=c[0][1],Z[14]=c[0][2],Q(Z,Z,O),re.push(Oe.instantiate({transformation:Z})),re.push(Se.instantiate({transformation:Z})),re};return{normal:g(!1),focused:g(!0)}}function Za(e,t,i){const a=[];for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*e,Math.sin(r)*e])}return Ri(i,a,t,[],[],!1)}function Xa(e,t){const i=x(J(),e[e.length-1],e[e.length-2]);if($(i,i),w(i,i,Fe),v(i,i,e[e.length-1]),t){const a=x(J(),e[0],e[1]);return $(a,a),w(a,a,Fe),v(a,a,e[0]),[a,...e,i]}return[...e,i]}function qt(e,t,i,a=new Ze){if(e==null)return null;const{renderCoordsHelper:s}=t,n=s.fromRenderCoords(e.origin,t.spatialReference);if(n==null)return null;const r=Ci(n,i);if(r==null)return null;a.position=r;const l=2*M(e.basis1),h=2*M(e.basis2),_=kt.renderUnitScaleFactor(t.spatialReference,i);a.width=l*_,a.height=h*_;const g=s.worldUpAtPosition(e.origin,o.get());return a.tilt=$i(Qe(e,g)),a.heading=s.headingAtPosition(e.origin,e.basis1)-90,a}function Qe(e,t){return Di(t,e.basis2,e.basis1)+se}function Ya(e,t,i,a,s,n,r=V()){return n.toRenderCoords(e,r.origin)?(n.worldBasisAtPosition(r.origin,lt.X,r.basis1),n.worldBasisAtPosition(r.origin,lt.Y,r.basis2),Dt(r.basis2,r.basis1,r.origin,r.plane),Ne(r,-me(t),Ve(r),r),Ne(r,me(i),r.basis1,r),w(r.basis1,r.basis1,a/2),w(r.basis2,r.basis2,s/2),Oi(r),r):(xt.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function Qa(e,t){if(e==null||e.position==null)return null;const i=qi(e.position,t.spatialReference,t.elevationProvider);if(i==null)return null;const a=kt.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*a,n=e.height*a;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:n}}function Ja(e,t,i,a=V()){if(e==null)return null;const s=Ya(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return i.tiltEnabled||s==null||La(s,t.renderCoordsHelper,s),s}(function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"})(G||(G={}));const m=Ce.Custom1;var ae,E;(function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"})(ae||(ae={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(E||(E={}));const Te=Ce.Custom2,ve=$t(),se=Math.PI/2,ke=Ce.Custom1,es=Ce.Custom2;var Ee;function ts(e){return(e.type==="building-scene-3d"?e:null)!=null}(function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Ee||(Ee={}));function is(e){switch(e.type){case"building-scene":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return Ii(e.type),!1}}const Zt="esri.views.3d.analysis.Slice.SliceController",xe=xt.getLogger(Zt);let X=class extends qe{constructor(e){super(e),this._handles=new Me,this._internalChange=!1,this._currentSlicePlane=null}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof gt||t instanceof Yi)?t instanceof gt&&is(t)?(xe.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(xe.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),ss(this.view,this),this._handles.add([R(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),R(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),R(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),R(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([R(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),ns(this.view,this),this._handles.destroy(),this.set("view",null)}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(ts).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(t==null&&e==null||t!=null&&e!=null&&e.equals(t))return;let i=null,a=null;if(e!=null&&e.position!=null){const s=e.position.spatialReference,n=Qa(e,this.view);n==null&&Zi(this.analysis,s,xe),i=Ja(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},V()),i!=null&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=qt(e,this.view,this.view.spatialReference,new Ze);let i=null;t!=null&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(Le)return;const e=Xt(this.view);if(e)if(this.analysisViewData.active)e.activeController!=null&&e.activeController!==this?(Le=!0,e.activeController.analysisViewData.active=!1,Le=!1):e.activeController!=null&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(e.activeController!=null&&e.activeController!==this)return;e.activeController!=null&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){as(this.view)}_updateLayerViews(){const e=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};u([d()],X.prototype,"view",void 0),u([d()],X.prototype,"analysis",void 0),u([d()],X.prototype,"analysisViewData",void 0),u([d()],X.prototype,"_allLayerAndSubLayerViews",null),X=u([ce(Zt)],X);const Y=new Map;let Le=!1;function as(e){const t=Xt(e),i=t==null?void 0:t.activeController;i!=null&&i.analysisViewData.plane!=null&&i.analysisViewData.visible?e.slicePlane=i.analysisViewData.plane:e.slicePlane=null}function ss(e,t){var i;Y.has(e)||Y.set(e,{all:[],activeController:null}),(i=Y.get(e))==null||i.all.push(t)}function Xt(e){return Y.get(e)}function ns(e,t){if(!Y.has(e))throw new Error("view expected in global slice register");const i=Y.get(e),a=(i==null?void 0:i.all.lastIndexOf(t))??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&Y.delete(e)}var We;let f=We=class extends ta{constructor(e){super(e),this._clock=Ai,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new Me,this._viewHandles=new Me,this._frameTask=null,this._pointerMoveTimerMs=wa,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=V(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=ki(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=xi(e.view.state.viewingMode),this._intersector.options.store=Li.MIN}initialize(){var s;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const e=!((s=this.view._stage)!=null&&s.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),t={accentColor:P.rotateManipulators.color,contrastColor:P.rotateManipulators.contrastColor,preMultiplyAlpha:e};this._rotateHeadingImage=na(this.view.toolViewManager.textures,t),this._rotateTiltImage=ra(this.view.toolViewManager.textures,t);const i=n=>{this._updateManipulatorsInteractive(n),n.grabbing||(this.analysisViewData.plane!=null&&b(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=Wa(this.view,{offsetMode:Ee.CENTER_ON_ARROW,calloutColor:P.callouts.color,color:P.shiftManipulator.color,outlineColor:P.shiftManipulator.outlineColor}),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",n=>{this._onShiftGrab(n),i(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=Et(this.view,this._rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",n=>{this._onRotateHeadingGrab(n),i(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=Et(this.view,this._rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",n=>{this._onRotateTiltGrab(n),i(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((n,r)=>{const l=Ka(this.view,n,{color:P.resizeManipulators.color});return l.events.on("grab-changed",h=>{this._onResizeGrab(h,r),i(l)}),this._handles.add(this._createResizeDragPipeline(l)),l}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Kt(this.view),this._previewPlaneOutlineVisualElement=Wt(this.view),this._previewPlaneOutlineVisualElement.width=Nt,this._handles.add(R(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),Hi));const a=R(()=>this.state,n=>{n==="sliced"&&this.finishToolCreation()},ze);this._handles.add([a,R(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._rotateHeadingImage=_t(this._rotateHeadingImage),this._rotateTiltImage=_t(this._rotateTiltImage),this._handles=W(this._handles),this._viewHandles=W(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=W(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=W(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",e)}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=e!=null&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!He(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!He(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!He(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&t!=null&&t.type==="shift"){const i=oe(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(oe(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const t=oe(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),b(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=oe(e),i=V();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(e.type==="pointer-drag"){const a=this._calculatePickRay(t);this.inputState=Ct(a,e.pointerId,i.origin,i)}return b(i,this._startPlane),this.analysis.shape=qt(i,this.view,this.view.spatialReference,new Ze),!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(oe(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),!0)}_onKeyDown(e){return(e.key===Ae||e.key===Ie)&&(this._activeKeyModifiers[e.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==Ae&&e.key!==Ie||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=this._calculatePickRay(e.screenPoint);b(this.analysisViewData.plane,this._startPlane),this.inputState=Ct(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const n=this.analysisViewData.plane!=null?b(this.analysisViewData.plane,V()):null;i.next(ye(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=.001,a=Math.min((1-Math.abs(A(Ve(this.analysisViewData.plane),t.ray.direction)/M(t.ray.direction)))/i,1),s=-wt(this._startPlane.plane,t.renderEnd),n=-wt(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(this.analysisViewData.plane==null)return;const t=I(o.get(),this._startPlane.origin),i=I(o.get(),Ve(this._startPlane));w(i,i,-e.depth),v(i,i,t);const a=Ge(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,V());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=Mt(this.analysisViewData.plane,this.view.renderCoordsHelper,ae.HEADING,Be()),i=this._calculatePickRay(e.screenPoint),a=J();fe(t,i,a)&&(b(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?b(this.analysisViewData.plane,V()):null;i.next(ye(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=Mt(this.analysisViewData.plane,this.view.renderCoordsHelper,ae.TILT,Be()),i=this._calculatePickRay(e.screenPoint),a=J();fe(t,i,a)&&(b(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?b(this.analysisViewData.plane,V()):null;i.next(ye(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=Gi(e.rotatePlane),a=ia(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(this.analysisViewData.plane==null)return;const t=Ui(k.get(),e.rotateAngle,e.rotateAxis);if(t==null)return;const i=yt(o.get(),this._startPlane.basis1,t),a=yt(o.get(),this._startPlane.basis2,t),s=Ge(this.analysisViewData.plane.origin,i,a,V());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const i=this._calculatePickRay(e.screenPoint),a=o.get();fe(this.analysisViewData.plane.plane,i,a)&&(b(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:St(a)})}_createResizeDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const n=b(this.analysisViewData.plane,V());i.next(ye(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(e){return t=>{if(this.analysisViewData.plane==null)return;const i=this._resizeHandles[e.activeHandleIdx],a=Ha(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,b(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(t==null)throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,e==null)return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=i??V();if(i=i!=null?b(i,rs):null,this._pickPlane(e,!0,t,a)){const s=fa;let n=!1;i!=null&&(n=A(i.plane,a.plane)<s||A($(o.get(),i.basis1),$(o.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=Ni({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*Pa),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=vt(this._frameTask)}_calculatePickRay(e){const t=$t(),i=ft(e,ls);return zi(this.view.state.camera,i,t),$(t.direction,t.direction),t}_pickMinResult(e){const t=ft(e,Bi.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=o.get();if(!s.getIntersectionPoint(n))return!1;const r=s.getTransformedNormal(o.get()),l=this.view.state.camera;A(r,l.viewForward)>0&&w(r,r,-1);const h=Ga(n,l),_=(t?1:-1)*h*ya,g=w(o.get(),r,_);v(g,g,n);const p=this.analysis.tiltEnabled?E.TILTED:E.HORIZONTAL_OR_VERTICAL,c=i[Ae]?E.VERTICAL:i[Ie]?E.HORIZONTAL:p;return ka(g,r,h,h,l,c,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=vt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=m,this.rotateHeadingManipulator.state|=m,this.rotateTiltManipulator.state|=m,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~m,this.rotateHeadingManipulator.state&=~m,this.rotateTiltManipulator.state&=~m},this._pointerMoveTimerMs)}_updateManipulators(){if(We.disableEngineLayers)return;let e,t=!1;if(this.analysisViewData.plane!=null)e=this.analysisViewData.plane,t=!1;else{if(this._previewPlane==null)return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=Ft(e,k.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(r=>r.available=!0),Na(this.shiftManipulator,i,e,this.view.state.camera),Fa(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),ja(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((r,l)=>Ba(r,this._resizeHandles[l],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=te(o.get(),M(e.basis1),M(e.basis2),1),s=Lt(k.get(),a),n=Q(s,i,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateMaterials(){const e=y.toUnitRGBA(P.plane.outlineColor);e[3]*=this._previewPlaneOpacity;const t=y.toUnitRGBA(P.plane.color);t[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=e,this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=Ht}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function Ct(e,t,i,a){const s=Ua(i,Ve(a),e.direction,Be()),n=J();return fe(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function He(e){return e.pointerType!=="mouse"||e.button===0}f.disableEngineLayers=!1,u([d()],f.prototype,"_clock",void 0),u([d({constructOnly:!0})],f.prototype,"view",void 0),u([d()],f.prototype,"analysisViewData",void 0),u([d({readOnly:!0})],f.prototype,"state",null),u([d({readOnly:!0})],f.prototype,"cursor",null),u([d()],f.prototype,"analysis",null),u([d()],f.prototype,"removeIncompleteOnCancel",void 0),u([d({readOnly:!0})],f.prototype,"layersMode",void 0),u([d({value:null})],f.prototype,"inputState",null),u([d()],f.prototype,"_isPlacingSlicePlane",null),u([d()],f.prototype,"_creatingPointerId",null),f=We=u([ce("esri.views.3d.analysis.Slice.SliceTool")],f);const rs=V(),ls=Fi(),os=f;let z=class extends qe{constructor(e){super(e),this._handles=new Me,this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const e=this.analysisViewData;if(e==null)throw new Error("expected internal object to be valid");this._gridVisualElement=Kt(this.view),this._outlineVisualElement=Wt(this.view),this._handles.add([R(()=>({visible:e.plane!=null&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),t=>this._updateMaterials(t),ze),R(()=>e.plane,t=>this._updatePlane(t),ze)],"internal")}destroy(){this._handles.destroy(),this._gridVisualElement=W(this._gridVisualElement),this._outlineVisualElement=W(this._outlineVisualElement),this.set("view",null)}_updatePlane(e){if(e==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const t=te(o.get(),M(e.basis1),M(e.basis2),1),i=Lt(k.get(),t),a=Ft(e,k.get()),s=Q(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a}){this._outlineVisualElement.color=y.toUnitRGBA(P.plane.outlineColor),this._outlineVisualElement.width=i?Nt:zt,this._outlineVisualElement.stipplePattern=t?null:ji(5),this._gridVisualElement.backgroundColor=y.toUnitRGBA(P.plane.color),this._gridVisualElement.gridColor=a?y.toUnitRGBA(P.plane.gridColor):Ht,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};u([d()],z.prototype,"view",void 0),u([d()],z.prototype,"analysis",void 0),u([d()],z.prototype,"analysisViewData",void 0),u([d()],z.prototype,"showGrid",void 0),u([d()],z.prototype,"preview",void 0),z=u([ce("esri.views.3d.analysis.Slice.SliceVisualization")],z);let S=class extends Xi(qe){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new z({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new X({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(aa(this,os))}destroy(){sa(this),this.analysisVisualization=W(this.analysisVisualization),this.analysisController=W(this.analysisController)}get showGrid(){var e;return((e=this.analysisVisualization)==null?void 0:e.showGrid)??!1}set showGrid(e){this.analysisVisualization&&(this.analysisVisualization.showGrid=e)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:this.tool}}};u([d({readOnly:!0})],S.prototype,"type",void 0),u([d({constructOnly:!0,nonNullable:!0})],S.prototype,"analysis",void 0),u([d()],S.prototype,"tool",void 0),u([d()],S.prototype,"plane",void 0),u([d()],S.prototype,"active",void 0),u([d()],S.prototype,"showGrid",null),u([d()],S.prototype,"editable",null),S=u([ce("esri.views.3d.analysis.SliceAnalysisView3D")],S);const us=S,Cs=Object.freeze(Object.defineProperty({__proto__:null,default:us},Symbol.toStringTag,{value:"Module"}));export{Cs as S,$a as t};
